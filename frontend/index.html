<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Observian Dashboard</title>

  <!-- Tailwind via CDN (build-time not required) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Heroicons for a toggle button icon -->
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <h1 class="text-3xl font-bold">Observian Dashboard</h1>
      <button id="toggleBtn"
        class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded">
        <span id="toggleText">Enable Ingestor</span>
        <i data-feather="play"></i>
      </button>
    </header>

    <!-- KPI cards -->
    <div id="kpis" class="grid grid-cols-3 gap-4"></div>

    <!-- Charts -->
    <canvas id="eventChart" class="bg-white rounded shadow p-4"></canvas>
    <canvas id="latencyChart" class="bg-white rounded shadow p-4 mt-6"></canvas>

    <!-- Live feed -->
    <div class="bg-white rounded shadow p-4 mt-6">
      <h2 class="text-xl font-semibold mb-2">Live Feed (last 25)</h2>
      <ul id="liveFeed" class="space-y-1 text-sm text-gray-800"></ul>
    </div>
  </div>

  <script>
  /* ---------- Config ---------- */
  const API = "https://observian.onrender.com"; 
  const KEY = "b345c446b9860103c1d3aead4bfab4f54e094a67d9f602594b22fd76b7893d76";                       // for control endpoints

  /* ---------- Utility ---------- */
  const headers = { "x-api-key": KEY, "Content-Type": "application/json" };

  /* ---------- Toggle Ingestor ---------- */
  document.getElementById("toggleBtn").onclick = async () => {
    const enabled = document.getElementById("toggleText").textContent.includes("Enable");
    await fetch(`${API}/control/ingestor-toggle?enable=${enabled}`, {
      method: "POST", headers
    });
    loadToggleState();   // refresh state
  };

  async function loadToggleState() {
    const res = await fetch(`${API}/control/ingestor-status`, { headers });
    const { enabled } = await res.json();
    const txt = enabled ? "Disable Ingestor" : "Enable Ingestor";
    const icon = enabled ? "pause" : "play";
    document.getElementById("toggleText").textContent = txt;
    feather.replace({ "stroke-width": 2 });
    document.querySelector("#toggleBtn i").setAttribute("data-feather", icon);
    feather.replace();
  }

  /* ---------- Live Feed + KPIs ---------- */
  async function loadFeed() {
    const res = await fetch(`${API}/logs/live-feed?limit=25`);
    const logs = await res.json();

    // live list
    const feed = document.getElementById("liveFeed");
    feed.innerHTML = "";
    logs.forEach(l => {
      feed.innerHTML += `<li>[${new Date(l.timestamp).toLocaleTimeString()}]
        <strong>${l.event_type ?? "—"}</strong> • ${l.service_name} • ${l.status_code}</li>`;
    });

    // KPI counts
    const total = logs.length;
    const errors = logs.filter(l => l.status_code >= 500).length;
    const avgLatency = (logs.reduce((s, l) => s + l.latency_ms, 0) / total).toFixed(1);

    document.getElementById("kpis").innerHTML = `
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-xl font-bold">${total}</p><p>Total Logs</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-xl font-bold">${errors}</p><p>Errors (5xx)</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-xl font-bold">${avgLatency} ms</p><p>Avg Latency</p>
      </div>`;

    return logs;
  }

  /* ---------- Charts ---------- */
  let eventChart, latencyChart;
  function buildCharts(logs) {
    // Group by timestamp minute + event_type
    const groups = {};
    logs.forEach(l => {
      const minute = new Date(l.timestamp).toISOString().slice(0, 16);
      if (!groups[minute]) groups[minute] = {};
      const ev = l.event_type || "Unknown";
      groups[minute][ev] = (groups[minute][ev] || 0) + 1;
    });
    const labels = Object.keys(groups).sort();
    const eventTypes = [...new Set(logs.map(l => l.event_type || "Unknown"))];

    const datasets = eventTypes.map((ev, i) => ({
      label: ev,
      data: labels.map(t => groups[t][ev] || 0),
      borderWidth: 2,
      fill: false,
    }));

    // Destroy old charts if they exist
    if (eventChart) eventChart.destroy();
    if (latencyChart) latencyChart.destroy();

    eventChart = new Chart(
      document.getElementById("eventChart"), {
        type: "line",
        data: { labels, datasets },
        options: { responsive: true, plugins:{ legend:{ position:"bottom"}} }
      });

    latencyChart = new Chart(
      document.getElementById("latencyChart"), {
        type: "bar",
        data: {
          labels: logs.map(l => new Date(l.timestamp).toLocaleTimeString()),
          datasets: [{
            label: "Latency (ms)",
            data: logs.map(l => l.latency_ms),
            borderWidth: 1
          }]
        },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true }}}
      });
  }

  /* ---------- Init ---------- */
  async function init() {
    await loadToggleState();
    const logs = await loadFeed();
    buildCharts(logs);
    // auto-refresh every 30 sec
    setInterval(async () => {
      const logs = await loadFeed();
      buildCharts(logs);
    }, 30000);
  }
  init();
  </script>
</body>
</html>